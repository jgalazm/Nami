<!DOCTYPE html>
<html lang="en">

<head>
    <title>tsunami.js</title>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/three.js/three.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


    <script src="scripts/shadersLib.js"></script>
    <script src="scripts/tsunamiModel.js"></script>
    <script src="scripts/TsunamiLab.js"></script>

    <style>
        body {
            background-color: black;
        }

        #bathymetry {
            /* display: none; */
            position: absolute;
            width: 800px;
            height: 400px;
        }

        canvas {
            position: absolute;
        }
    </style>

    <script>
        "use strict"
        var model, tsunamiLab;
        $(function () {
            var inputParameters = {
                bathymetry: {
                    img: $('#bathymetry')[0],
                    metadata: {
                       ny: 2159,
                       nx: 1079,
                       xyzmin: [-180, -90, -10547],
                       xyzmax: [359.8333-180, 89.8333, 6603]

                    }
                },

                finiteFault: {
                    L: 450000.0,
                    W: 150000.0,
                    depth: 30100,
                    slip: 6.06,
                    strike: 18.0,
                    dip: 18.0,
                    rake: 112.0,
                    U3: 0.0,
                    cn: 0.5*(-39-32),
                    ce: 0.5*(-75-71)
                },
                mesh: {
                    width: 1024,
                    height: 512
                }
            }

            var outputParameters = {
                resolution: {
                    width: 800,
                    height: 400
                },
                pois : {
                    'p1': {
                        coords: [-80.108548,  -26.292215],
                        time: [],
                        height: []
                    },
                    'p2':{
                        coords: [-109.439426, -27.15485],
                        time: [],
                        height: []
                    }
                }                
            }   
            // model = TsunamiModel(inputParameters,outputParameters);
            tsunamiLab = new TsunamiLab(inputParameters, outputParameters);



            var t = 0;
            var nsteps = 100;
            var tick = function () {
                if (t <= nsteps) {
                    t++;
                    // console.log(t);
                    tsunamiLab.model.renderSimulation();
                    tsunamiLab.model.renderScreenVoid();
                    // tsunamiLab.model.renderMaxHeights();
                    // tsunamiLab.model.renderMaxHeightsVisualization();
                    tsunamiLab.model.storePOISValues();
                    requestAnimationFrame(tick);
                    if(t%10==0){
                        tsunamiLab.model.store2DHeightValues();
                    }
                }
                else {
                    var data = [];

                    Object.keys(tsunamiLab.model.pois).forEach(function(poi){
                        var trace = {
                            x: tsunamiLab.model.pois[poi].time,
                            y: tsunamiLab.model.pois[poi].height,
                            type: 'line'
                        };                        
                        data.push(trace);
                    });

                    var layout = {
                        width: 800,
                        height: 400
                    };

                    //save pois to file

                    var exportString = "#time(min)";
                    Object.keys(tsunamiLab.model.pois).forEach(function(poi){
                        exportString +=','+poi+'(m)';
                    });
                    exportString+='\n';
                    for(var i=0;i< nsteps;i++){
                        exportString += tsunamiLab.model.pois[Object.keys(tsunamiLab.model.pois)[0]].time[i].toFixed(8).toString();
                        
                        
                        Object.keys(tsunamiLab.model.pois).forEach(function(poi){
                            exportString += ','+tsunamiLab.model.pois[poi].height[i].toFixed(8).toString();
                        });

                        exportString += '\n';
                    }
                    exportString = 'data:text/csv;charset=utf-8,'+exportString;
                    
                    // exportString = encodeURI(exportString);

                    
                    $('#poisshow').click(function(){
                        Plotly.newPlot('pois', data, layout);
                    });

                    $('#poisdown').click(function(){
                        var link = document.createElement("a");
                        link.href =  exportString;
                        link.download = "tseries";
                        link.click();
                    });
                    $('#gridDownload').click(function(){
                        tsunamiLab.model.gridValues.forEach(function(gridHeights,index){
                            var outputURL = tsunamiLab.model.convertGridToString(gridHeights)

                            var link = document.createElement("a");
                            link.href =  outputURL;
                            link.download = "tlab2D."+(index*10).toString().padStart(5,'0');
                            link.click();  
                        });



                        
                    });
                    
                }
            }
            requestAnimationFrame(tick);


        });
    </script>
</head>

<body>
    <button id='poisshow'> Mostrar </button>
    <button id='poisdown'> Bajar </button>
    <button id='gridDownload'> Save 2D </button>

    <div id="pois"></div>
    <img id="bathymetry" src="data/gebco10mins.jpg"></img>

    
</body>

</html>